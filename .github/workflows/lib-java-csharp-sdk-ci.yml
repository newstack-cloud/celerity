# CI workflow for Java & C# Runtime SDK FFI crates.
# Runs linting and a single-platform build + test for fast feedback on push/PR.
# The full cross-platform matrix runs in the release workflow.
name: Java & C# Runtime SDK CI

on:
  push:
    branches:
      - main
    paths:
      - 'libs/runtime/sdk/bindgen-ffi/**'
      - 'libs/runtime/sdk/bindgen-ffi-java/**'
      - 'libs/runtime/sdk/bindings/**'
      - 'libs/runtime/sdk/runtime-bindings/**'
      - 'libs/runtime/sdk/java/**'
      - 'libs/runtime/sdk/csharp/**'
      - '!**/*.md'
      - '!LICENSE'
      - '!**/*.gitignore'
      - '!.editorconfig'
      - '!docs/**'
  pull_request:
    paths:
      - 'libs/runtime/sdk/bindgen-ffi/**'
      - 'libs/runtime/sdk/bindgen-ffi-java/**'
      - 'libs/runtime/sdk/bindings/**'
      - 'libs/runtime/sdk/runtime-bindings/**'
      - 'libs/runtime/sdk/java/**'
      - 'libs/runtime/sdk/csharp/**'
      - '!**/*.md'
      - '!LICENSE'
      - '!**/*.gitignore'
      - '!.editorconfig'
      - '!docs/**'
  workflow_dispatch: {}

jobs:
  linting:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: libs/runtime
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - name: Format
        run: cargo fmt --all -- --check
      - name: Clippy
        run: cargo clippy -- -D warnings

  build-and-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: libs/runtime
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Install Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      - name: Build FFI and JNI
        run: cargo build --release -p celerity_runtime_bindgen_ffi -p celerity_runtime_bindgen_ffi_java
      - name: Test .NET bindings
        run: cargo run --bin celerity-runtime-bindings -- --dotnet
        env:
          CELERITY_VARIABLE_secretStoreId: test-secret-store
          CELERITY_VARIABLE_certificateId: test-certificate
          CELERITY_VARIABLE_logLevel: debug
          CELERITY_VARIABLE_paymentApiSecret: test-payment-api-secret
      - name: Test Java bindings
        run: cargo run --bin celerity-runtime-bindings -- --java
        env:
          CELERITY_VARIABLE_secretStoreId: test-secret-store
          CELERITY_VARIABLE_certificateId: test-certificate
          CELERITY_VARIABLE_logLevel: debug
          CELERITY_VARIABLE_paymentApiSecret: test-payment-api-secret
